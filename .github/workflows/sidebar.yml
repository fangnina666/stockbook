name: Sync reports_his & Generate _sidebar.md

on:
  schedule:
    - cron: '0 * * * *'   # æ¯å¤© 00:00 UTCï¼ˆå°ç£ 08:00ï¼‰
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync_and_build_sidebar:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone public repo (sparse reports_his only)
        run: |
          git clone --depth 1 --filter=blob:none --sparse https://github.com/fangnina666/gitbook.git src
          cd src
          git sparse-checkout set reports_his
          cd ..

      - name: Sync to target reports_his (with delete)
        run: |
          mkdir -p reports_his
          if [ -d src/reports_his ]; then
            rsync -av --delete src/reports_his/ reports_his/
          else
            echo "WARN: src/reports_his not found; leaving reports_his as-is"
          fi
          rm -rf src

      - name: Ensure Docsify essentials (.nojekyll & README.md)
        run: |
          set -euo pipefail
          [ -f .nojekyll ] || touch .nojekyll
          if [ ! -f README.md ]; then
            {
              printf '%s\n' '# æ­¡è¿ä¾†åˆ° StockBook'
              printf '%s\n' '- å¾å·¦å´é¸æ“‡å ±å‘Šï¼Œæˆ–å‰å¾€ [reports_his](#/reports_his/)ã€‚'
            } > README.md
          fi

      # âœ… åªä¿ç•™ã€Œå¯æŠ˜ç–Šã€ç‰ˆæœ¬ï¼Œé¿å…ç”¢ç”Ÿå…©æ¬¡ _sidebar.md äº’ç›¸è¦†è“‹
      - name: Generate _sidebar.md (Year/Month/Day collapsible)
        shell: bash
        run: |
          set -euo pipefail
          SIDEBAR_PATH="_sidebar.md"
          ROOT_DIR="reports_his"

          echo "Generating ${SIDEBAR_PATH} (Y/M/Day nodes; items per day) from ${ROOT_DIR}/*.md ..."

          # æŠ“æª”æ¸…å–®ï¼šè¼¸å‡º "epoch|filename"
          mapfile -t RAW < <(
            find "${ROOT_DIR}" -maxdepth 1 -type f -name "*.md" -printf '%T@|%f\n'
          )

          # è½‰æˆ "YYYYMMDD|epoch|filename"ï¼ˆå„ªå…ˆæª”åå…§æ—¥æœŸï¼›ç„¡å‰‡ç”¨ mtimeï¼‰
          LINES=()
          for line in "${RAW[@]}"; do
            epoch="${line%%|*}"; file="${line#*|}"; epoch_int="${epoch%.*}"
            dn="$(printf '%s' "$file" | grep -oE '[0-9]{8}(_[0-9]{6})?' | tail -n1 || true)"
            if [[ -n "${dn}" ]]; then
              ymd="${dn:0:8}"
            else
              ymd="$(date -u -d "@${epoch_int}" +%Y%m%d)"
            fi
            LINES+=("${ymd}|${epoch}|${file}")
          done

          # ä¾æ—¥æœŸ(é™å†ª)â†’mtime(é™å†ª)æ’åº
          IFS=$'\n' LINES_SORTED=($(printf '%s\n' "${LINES[@]}" | sort -r -t '|' -k1,1 -k2,2)); unset IFS

          {
            echo "- [é¦–é ](/README.md)"
            echo "- å ±å‘Šåˆ—è¡¨"

            if [ ${#LINES_SORTED[@]} -eq 0 ]; then
              echo "  - ï¼ˆç›®å‰æ²’æœ‰æª”æ¡ˆï¼‰"
            else
              cur_y=""; cur_m=""; cur_d=""

              for item in "${LINES_SORTED[@]}"; do
                day_ymd="${item%%|*}"
                rest="${item#*|}"
                file="${rest#*|}"

                y="${day_ymd:0:4}"; m="${day_ymd:4:2}"; d="${day_ymd:6:2}"
                y_label="${y} å¹´"
                m_label="${m} æœˆ"
                d_label="${y}-${m}-${d}"    # ã€Œæ—¥ã€å±¤ç´šé¡¯ç¤ºå­—æ¨£ï¼ˆä¸åŠ é€£çµï¼‰
                base="${file%.md}"

                # âœ… é¡¯ç¤ºåç¨±è½‰æ›ï¼ˆåªå½±éŸ¿ sidebarï¼Œä¸æ”¹æª”åï¼‰
                if [[ "$base" =~ ^result_combined_reco_([0-9]{8}) ]]; then
                  reco_ymd="${BASH_REMATCH[1]}"
                  title="ğŸ“Œ é¸è‚¡æ‘˜è¦ (${reco_ymd})"
                elif [[ "$base" == result_combined_reco* ]]; then
                  title="ğŸ“Œ é¸è‚¡æ‘˜è¦"
                else
                  title="$base"
                fi

                safe_path="${ROOT_DIR}/${file// /%20}"

                # å¹´å±¤ï¼ˆç¯€é»ï¼‰
                if [[ "${y}" != "${cur_y}" ]]; then
                  echo "  - ${y_label}"
                  cur_y="${y}"
                  cur_m=""
                  cur_d=""
                fi

                # æœˆå±¤ï¼ˆç¯€é»ï¼‰
                if [[ "${m}" != "${cur_m}" ]]; then
                  echo "    - ${m_label}"
                  cur_m="${m}"
                  cur_d=""
                fi

                # æ—¥å±¤ï¼ˆç¯€é»ï¼Œç„¡é€£çµï¼›è®“å®ƒå¯æŠ˜ç–Šï¼‰
                if [[ "${d_label}" != "${cur_d}" ]]; then
                  echo "      - ${d_label}"
                  cur_d="${d_label}"
                fi

                # æª”æ¡ˆé …ç›®ï¼ˆé€£çµæ”¾åœ¨æ—¥ç¯€é»åº•ä¸‹ï¼‰
                echo "        - [${title}](/${safe_path})"
              done
            fi
          } > "${SIDEBAR_PATH}"

          echo "âœ… ${SIDEBAR_PATH} generated."

      - name: Commit and push if changed (reports_his + _sidebar.md + README.md + .nojekyll)
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add reports_his/ _sidebar.md README.md .nojekyll || true
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            TS="$(date -u +'%Y-%m-%d %H:%M:%S') UTC"
            git commit -m "chore: sync reports_his from gitbook & regenerate _sidebar.md at ${TS}"
            git push
          fi
